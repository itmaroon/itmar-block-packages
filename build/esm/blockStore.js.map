{"version":3,"file":"blockStore.js","sources":["../../src/blockStore.js"],"sourcesContent":["import { useSelect } from \"@wordpress/data\";\r\nimport { store as blockEditorStore } from \"@wordpress/block-editor\";\r\nimport { createBlock } from \"@wordpress/blocks\";\r\n\r\nexport const useTargetBlocks = (\r\n  clientId,\r\n  blockName,\r\n  attributeFilter = null,\r\n  includeNested = false\r\n) => {\r\n  const targetblocks = useSelect(\r\n    (select) => {\r\n      const { getBlockRootClientId, getBlock } = select(blockEditorStore);\r\n\r\n      const parentId = getBlockRootClientId(clientId); // 自分の親の clientId を取得\r\n      if (!parentId) return attributeFilter ? null : [];\r\n\r\n      const parentBlock = getBlock(parentId);\r\n      if (!parentBlock) return attributeFilter ? null : [];\r\n\r\n      const siblingBlocks = includeNested\r\n        ? flattenBlocks(parentBlock.innerBlocks || []) //ネストされたブロックも含んで検索\r\n        : parentBlock.innerBlocks || []; //兄弟ブロックのみ\r\n\r\n      const filtered = siblingBlocks.filter(\r\n        (block) => block.name === blockName && block.clientId !== clientId\r\n      );\r\n\r\n      if (attributeFilter) {\r\n        return (\r\n          filtered.find((block) => {\r\n            return Object.entries(attributeFilter).every(\r\n              ([key, value]) => block.attributes[key] === value\r\n            );\r\n          }) || null\r\n        );\r\n      }\r\n\r\n      return filtered;\r\n    },\r\n    [clientId, blockName, JSON.stringify(attributeFilter), includeNested]\r\n  );\r\n  return targetblocks;\r\n};\r\n\r\n//ネストしたブロックを平坦化\r\nexport const flattenBlocks = (blocks) => {\r\n  return blocks.reduce((acc, block) => {\r\n    acc.push(block);\r\n    if (block.innerBlocks && block.innerBlocks.length > 0) {\r\n      acc.push(...flattenBlocks(block.innerBlocks));\r\n    }\r\n    return acc;\r\n  }, []);\r\n};\r\n\r\n// 再帰的にブロック構造をシリアライズする関数\r\nexport const serializeBlockTree = (block) => {\r\n  return {\r\n    blockName: block.name,\r\n    attributes: block.attributes,\r\n    innerBlocks:\r\n      block.innerBlocks.length > 0\r\n        ? block.innerBlocks.map(serializeBlockTree)\r\n        : [],\r\n  };\r\n};\r\n// シリアライズしたブロックデータをもとの階層構造に戻す関数\r\nexport const createBlockTree = (blockData) => {\r\n  const inner = Array.isArray(blockData.innerBlocks)\r\n    ? blockData.innerBlocks.map(createBlockTree)\r\n    : [];\r\n\r\n  return createBlock(blockData.blockName, blockData.attributes, inner);\r\n};\r\n"],"names":["useTargetBlocks","clientId","blockName","attributeFilter","arguments","length","undefined","includeNested","targetblocks","useSelect","select","getBlockRootClientId","getBlock","blockEditorStore","parentId","parentBlock","siblingBlocks","flattenBlocks","innerBlocks","filtered","filter","block","name","find","Object","entries","every","_ref","key","value","attributes","JSON","stringify","blocks","reduce","acc","push","serializeBlockTree","map","createBlockTree","blockData","inner","Array","isArray","createBlock"],"mappings":"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"}