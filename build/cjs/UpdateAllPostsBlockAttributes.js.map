{"version":3,"file":"UpdateAllPostsBlockAttributes.js","sources":["../../src/UpdateAllPostsBlockAttributes.js"],"sourcesContent":["import { useState, useRef } from \"@wordpress/element\";\r\nimport { __ } from \"@wordpress/i18n\";\r\nimport { ProgressBar, Button } from \"@wordpress/components\";\r\nimport { parse, serialize } from \"@wordpress/blocks\";\r\nimport apiFetch from \"@wordpress/api-fetch\";\r\n\r\n//特定の投稿タイプの投稿に含まれる本ブロックの属性を書き換える\r\n\r\nexport default function UpdateAllPostsBlockAttributes({\r\n  postType,\r\n  blockName,\r\n  newAttributes,\r\n  onProcessStart,\r\n  onProcessEnd,\r\n  onProcessCancel,\r\n}) {\r\n  const [progress, setProgress] = useState(0);\r\n  // stateではなくrefを使用してキャンセル状態を管理する\r\n  const cancelRef = useRef(false);\r\n  const updatePostBlockAttributes = async () => {\r\n    try {\r\n      const allPosts = [];\r\n      let page = 1;\r\n      let hasMore = true;\r\n      while (hasMore) {\r\n        // REST APIを使ってすべての投稿を取得（投稿タイプを指定）\r\n        const path = `/wp/v2/${postType}?per_page=100&page=${page}&context=edit`;\r\n        const posts = await apiFetch({ path });\r\n        allPosts.push(...posts);\r\n        // 投稿が100件未満の場合、次のページは存在しない\r\n        if (posts.length < 100) {\r\n          hasMore = false;\r\n        } else {\r\n          page += 1; // 次のページに進む\r\n        }\r\n      }\r\n      let allCount = allPosts.length;\r\n      let processCount = 0;\r\n      // キャンセルフラグをリセット\r\n      cancelRef.current = false;\r\n\r\n      for (const post of allPosts) {\r\n        if (!post.content || !post.content.raw) {\r\n          console.warn(`Post ID ${post.id} does not contain raw content.`);\r\n          continue;\r\n        }\r\n        // ループの各回でキャンセルがリクエストされているかチェック\r\n        if (cancelRef.current) {\r\n          console.log(\"処理がキャンセルされました。\");\r\n          return;\r\n        }\r\n\r\n        const content = post.content.raw;\r\n        const blocks = parse(content);\r\n        // 特定のブロックの属性を更新\r\n        const updatedBlocks = blocks.map((block) => {\r\n          if (block.name === blockName) {\r\n            // 属性をマージして更新\r\n            block.attributes = {\r\n              ...block.attributes,\r\n              ...newAttributes,\r\n            };\r\n          }\r\n          return block;\r\n        });\r\n\r\n        // 更新後のブロックをシリアライズ\r\n        const updatedContent = serialize(updatedBlocks);\r\n\r\n        // REST APIを使って投稿を更新\r\n        try {\r\n          await apiFetch({\r\n            path: `/wp/v2/${postType}/${post.id}`,\r\n            method: \"POST\",\r\n            data: { content: updatedContent },\r\n          });\r\n        } catch (error) {\r\n          console.error(`Failed to update post ID ${post.id}:`, error.message);\r\n          if (error.data) {\r\n            console.error(\"Error details:\", error.data);\r\n          }\r\n        }\r\n        //カウンターセットとプログレスバーの処理\r\n        processCount++;\r\n        setProgress(Math.round((processCount / allCount) * 100));\r\n      }\r\n\r\n      //終了処理\r\n      onProcessEnd();\r\n    } catch (error) {\r\n      console.error(\"Error updating block attributes:\", error);\r\n    }\r\n  };\r\n  return (\r\n    <>\r\n      <ProgressBar value={progress} className=\"markdown_copy_progress\" />\r\n      <p>{progress}%</p>\r\n      <div style={{ width: \"fit-content\", margin: \"20px auto 0\" }}>\r\n        <Button\r\n          variant=\"primary\"\r\n          onClick={() => {\r\n            onProcessStart(); //親コンポーネントでスタート処理\r\n            updatePostBlockAttributes();\r\n          }}\r\n          disabled={progress > 0 && progress < 100}\r\n        >\r\n          {__(\"Start Process\", \"markdown-block\")}\r\n        </Button>\r\n        <Button\r\n          variant=\"secondary\"\r\n          onClick={() => {\r\n            if (progress === 0 || cancelRef.current) {\r\n              onProcessEnd(); // 処理が始まる前ならすぐに終了処理を実行\r\n            } else {\r\n              // キャンセルフラグを更新（refならすぐに反映される）\r\n              cancelRef.current = true;\r\n              onProcessCancel(); //親コンポーネントでキャンセル処理\r\n            }\r\n          }}\r\n          style={{ marginLeft: \"10px\" }}\r\n        >\r\n          {__(\"Cancel\", \"markdown-block\")}\r\n        </Button>\r\n      </div>\r\n    </>\r\n  );\r\n}\r\n"],"names":["UpdateAllPostsBlockAttributes","_ref","postType","blockName","newAttributes","onProcessStart","onProcessEnd","onProcessCancel","progress","setProgress","useState","cancelRef","useRef","updatePostBlockAttributes","_ref2","_asyncToGenerator","allPosts","page","hasMore","path","concat","posts","apiFetch","push","length","allCount","processCount","current","post","content","raw","console","warn","id","log","blocks","parse","updatedBlocks","map","block","name","attributes","_objectSpread","updatedContent","serialize","method","data","error","message","Math","round","apply","arguments","React","createElement","Fragment","ProgressBar","value","className","style","width","margin","Button","variant","onClick","disabled","__","marginLeft"],"mappings":"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"}