{"version":3,"file":"MasonryControl.js","sources":["../../src/MasonryControl.js"],"sourcesContent":["/**\r\n * Masonry グリッドを初期化する共通関数\r\n *\r\n * @param {HTMLElement} gridEl - `.itmar-masonry-grid` のコンテナ要素\r\n * @param {Array<{ url: string, alt?: string }>} images - 描画する画像リスト\r\n * @param {Object} options\r\n * @param {number} options.columns - カラム数\r\n * @param {boolean} [options.renderItems=true]\r\n *   true: この関数内で gridEl をクリアして <figure><img> を追加する\r\n *   false: 既にある .itmar-masonry-item をそのまま使い、幅だけ更新する\r\n *\r\n * @returns {any|null} Masonry インスタンス（なければ null）\r\n */\r\n\r\nexport default function MasonryControl(\r\n  gridEl,\r\n  images = [],\r\n  { columns = 1, renderItems = true } = {}\r\n) {\r\n  if (!gridEl) return null;\r\n  const columnWidthPercent = 100 / (columns || 1);\r\n\r\n  // 既存インスタンスがあれば破棄（再初期化に対応）\r\n  if (gridEl.__masonryInstance) {\r\n    try {\r\n      gridEl.__masonryInstance.destroy();\r\n    } catch (e) {\r\n      console.warn(\"Failed to destroy previous Masonry instance\", e);\r\n    }\r\n    gridEl.__masonryInstance = null;\r\n  }\r\n\r\n  // ---------------------------\r\n  // 1) アイテムの DOM を構築 or 更新\r\n  // ---------------------------\r\n  if (renderItems) {\r\n    // ★ コンテナ全部は消さない。マソンリー用の要素だけを削除する\r\n    gridEl\r\n      .querySelectorAll(\".itmar-masonry-sizer, .itmar-masonry-item\")\r\n      .forEach((node) => node.remove());\r\n\r\n    // sizer 追加\r\n    const sizer = document.createElement(\"div\");\r\n    sizer.className = \"itmar-masonry-sizer\";\r\n    sizer.style.width = `${columnWidthPercent}%`;\r\n    gridEl.appendChild(sizer);\r\n\r\n    // 画像アイテム追加\r\n    images.forEach((item, index) => {\r\n      const fig = document.createElement(\"figure\");\r\n      fig.className = \"itmar-masonry-item\";\r\n      fig.style.width = `${columnWidthPercent}%`;\r\n\r\n      // クリック検知用の a タグ\r\n      const link = document.createElement(\"a\");\r\n      link.href = \"#\";\r\n      link.className = \"itmar-masonry-link\";\r\n      link.dataset.masonryIndex = String(index);\r\n      //img要素\r\n      const img = document.createElement(\"img\");\r\n      img.src = item.url;\r\n      img.alt = item.alt || \"\";\r\n      img.style.display = \"block\";\r\n      img.style.width = \"100%\";\r\n      img.style.height = \"auto\";\r\n\r\n      link.appendChild(img);\r\n      fig.appendChild(link);\r\n      gridEl.appendChild(fig);\r\n    });\r\n  } else {\r\n    // React 側（edit.js）みたいに、すでに <figure> が描画されている場合\r\n    // sizer がなければ作る\r\n    let sizer = gridEl.querySelector(\".itmar-masonry-sizer\");\r\n    if (!sizer) {\r\n      sizer = document.createElement(\"div\");\r\n      sizer.className = \"itmar-masonry-sizer\";\r\n      gridEl.insertBefore(sizer, gridEl.firstChild || null);\r\n    }\r\n    sizer.style.width = `${columnWidthPercent}%`;\r\n\r\n    // 既存 item の幅だけ更新\r\n    gridEl.querySelectorAll(\".itmar-masonry-item\").forEach((fig) => {\r\n      fig.style.width = `${columnWidthPercent}%`;\r\n    });\r\n  }\r\n\r\n  // ---------------------------\r\n  // 2) Masonry / imagesLoaded を iframe-aware に取得\r\n  // ---------------------------\r\n  let win = null;\r\n\r\n  if (gridEl.ownerDocument && gridEl.ownerDocument.defaultView) {\r\n    // サイトエディタ・ブロックエディタの iframe 内ならこっち\r\n    win = gridEl.ownerDocument.defaultView;\r\n  } else if (typeof window !== \"undefined\") {\r\n    // フロントなら普通に window\r\n    win = window;\r\n  }\r\n\r\n  if (!win || !win.Masonry || !win.imagesLoaded) {\r\n    // ライブラリが読み込まれていない場合は、\r\n    // DOM だけ作って終了（レイアウトはブラウザ任せ）\r\n    return null;\r\n  }\r\n\r\n  const MasonryCtor = win.Masonry;\r\n  const imagesLoadedFn = win.imagesLoaded;\r\n\r\n  const msnry = new MasonryCtor(gridEl, {\r\n    itemSelector: \".itmar-masonry-item\",\r\n    columnWidth: \".itmar-masonry-sizer\",\r\n    percentPosition: true,\r\n  });\r\n\r\n  const imgLoad = imagesLoadedFn(gridEl);\r\n  imgLoad.on(\"progress\", () => {\r\n    msnry.layout();\r\n  });\r\n\r\n  // 後から破棄できるように要素に紐付けておく\r\n  gridEl.__masonryInstance = msnry;\r\n\r\n  return msnry;\r\n}\r\n"],"names":["MasonryControl","gridEl","images","arguments","length","undefined","columns","renderItems","columnWidthPercent","__masonryInstance","destroy","e","console","warn","querySelectorAll","forEach","node","remove","sizer","document","createElement","className","style","width","concat","appendChild","item","index","fig","link","href","dataset","masonryIndex","String","img","src","url","alt","display","height","querySelector","insertBefore","firstChild","win","ownerDocument","defaultView","window","Masonry","imagesLoaded","MasonryCtor","imagesLoadedFn","msnry","itemSelector","columnWidth","percentPosition","imgLoad","on","layout"],"mappings":"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"}